---
title: "T1E simulation"
author: "Jianhui Gao"
date: "06/04/2022"
output: pdf_document
---

```{r setup, include=FALSE, echo=FALSE}
library(dplyr)
knitr::opts_chunk$set(echo = FALSE)
source("/Users/jianhuigao/Library/CloudStorage/OneDrive-UniversityofToronto/EHR_research/SyntheticSurrogateAnalysis/Code/SynSurrogateSim.R")
```

This document is a bit informal, but I hope it's informative!

## Parameter set-up

-   sample size $N = 10^3$

-   Number of replicates: $10^5$

-   Genotypes are generated $G \sim Bin(2, \text{maf}), \text{maf}\sim Unif[0.05, 0.5]$

-   Target phenotypes $Y_i \sim N(X_i^T\beta,1)$, where $X_i= (1 ,x_{1,i},x_{2_i})$ and $x_{1,i}, x_{2,i} \sim N(0,1)$.

-   Surrogate $S_i \sim N(X_i^T\beta+\rho(Y_i-X_i^T\beta),1-\rho^2)$.

-   Code is borrowed from zack's [github](https://github.com/zrmacc/Synthetic-Surrogates/blob/master/simulation_code/SynSurrogateSim/R/data_generation.R).

-   $\rho \in \{0, 0.25, 0.5, 0.75\}$

-   missing rate of target phenotype $m\in \{0, 0.25, 0.5, 0.75\}$

-   $\beta = (1,1,2)$

```{r}

pheno <- GenPheno(10^3, beta=c(1,1,2))
hist(pheno$target, main = "Histogram of simulated phenotype (1 simulation)")
```


## Result

With $10^5$ replicates, i did not see inflated t1e for surrogate?

```{r}
n.sim <- 10^4
t1e <- readRDS(paste0("/Users/jianhuigao/Library/CloudStorage/OneDrive-UniversityofToronto/EHR_research/SyntheticSurrogateAnalysis/Data/", "t1e,nsim=", n.sim, ".rds"))
prop <- c()
for (m in 1:4) {
  for (j in 1:4) {
    rate <- c(0, 0.25, 0.5, 0.75)[m]
    p <- c(0, 0.25, 0.5, 0.75)[j]
    n <- n.sim

    prop.oracle <- sum(unlist(lapply(1:n, function(i) {
      return(t1e[[i]][[m]][[j]][["oracle.p"]])
    })) < 0.05) / n
    prop.target <- sum(unlist(lapply(1:n, function(i) {
      return(t1e[[i]][[m]][[j]][["target.p"]])
    })) < 0.05) / n
    prop.surrogate <- sum(unlist(lapply(1:n, function(i) {
      return(t1e[[i]][[m]][[j]][["surrogate.p"]])
    })) < 0.05) / n
    prop.bi <- sum(unlist(lapply(1:n, function(i) {
      return(t1e[[i]][[m]][[j]][["bi.p"]])
    })) < 0.05) / n

    prop <- rbind(prop, c(rate, p, prop.oracle, prop.target, prop.surrogate, prop.bi))
  }
}
prop <- prop %>% data.frame()
colnames(prop) <- c("mssing", "rho", "oracle", "target", "surrogate", "bivariate")
prop %>% knitr::kable(booktabs = T, caption = "Proportion of test making type I error")
```

```{r}
chi <- c()
for (m in 1:4) {
  for (j in 1:4) {
    rate <- c(0, 0.25, 0.5, 0.75)[m]
    p <- c(0, 0.25, 0.5, 0.75)[j]
    n <- n.sim

    chi.oracle <- mean(unlist(lapply(1:n, function(i) {
      return((t1e[[i]][[m]][[j]][["oracle.beta"]] / t1e[[i]][[m]][[j]][["oracle.se"]])^2)
    })))
    chi.target <- mean(unlist(lapply(1:n, function(i) {
      return((t1e[[i]][[m]][[j]][["target.beta"]] / t1e[[i]][[m]][[j]][["target.se"]])^2)
    })))
    chi.surrogate <- mean(unlist(lapply(1:n, function(i) {
      return((t1e[[i]][[m]][[j]][["surrogate.beta"]] / t1e[[i]][[m]][[j]][["surrogate.se"]])^2)
    })))
    chi.bi <- mean(unlist(lapply(1:n, function(i) {
      return((t1e[[i]][[m]][[j]][["bi.beta"]] / t1e[[i]][[m]][[j]][["bi.se"]])^2)
    })))

    chi <- rbind(chi, c(rate, p, chi.oracle, chi.target, chi.surrogate, chi.bi))
  }
}
chi <- chi %>% data.frame()
colnames(chi) <- c("mssing", "rho", "oracle", "target", "surrogate", "bivariate")
chi %>% knitr::kable(booktabs = T, caption = "Average chi-square statistics across SNPs")
```
